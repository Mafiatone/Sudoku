<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sudoku ‚Äì Your Ad-Free App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --bg: #111827;
      --card: #020617;
      --accent: #fbbf24;
      --grid-line: #374151;
      --grid-sub: #4b5563;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #f97373;
      --given: #e5e7eb;
      --cell-bg: #020617;
      --cell-selected: #1d4ed8;
      --cell-related: #020617;
      --same-bg: rgba(250, 204, 21, 0.18);
      --same-border: rgba(250, 204, 21, 0.7);
      --same-text: #facc15;
    }

    /* THEMES */
    body.theme-classic {
      --bg: #111827;
      --card: #020617;
      --accent: #fbbf24;
      --grid-line: #374151;
      --grid-sub: #4b5563;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #f97373;
      --given: #e5e7eb;
      --cell-bg: #020617;
      --cell-selected: #1d4ed8;
      --cell-related: #020617;
      --same-bg: rgba(250, 204, 21, 0.18);
      --same-border: rgba(250, 204, 21, 0.7);
      --same-text: #facc15;
    }

    body.theme-neon {
      --bg: #020617;
      --card: #020617;
      --accent: #22c55e;
      --grid-line: #22c55e;
      --grid-sub: #4ade80;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #fb7185;
      --given: #f9fafb;
      --cell-bg: #020617;
      --cell-selected: #22c55e;
      --cell-related: #020617;
      --same-bg: rgba(34, 197, 94, 0.18);
      --same-border: rgba(34, 197, 94, 0.7);
      --same-text: #4ade80;
    }

    body.theme-neonpink {
      --bg: #020617;
      --card: #020617;
      --accent: #ec4899;
      --grid-line: #ec4899;
      --grid-sub: #fb7185;
      --text: #f9fafb;
      --muted: #e5e7eb;
      --error: #fb7185;
      --given: #fdf2f8;
      --cell-bg: #020617;
      --cell-selected: #ec4899;
      --cell-related: #020617;
      --same-bg: rgba(236, 72, 153, 0.2);
      --same-border: rgba(236, 72, 153, 0.85);
      --same-text: #fb7185;
    }

    body.theme-bright {
      --bg: #e5e7eb;
      --card: #f9fafb;
      --accent: #2563eb;
      --grid-line: #d1d5db;
      --grid-sub: #9ca3af;
      --text: #111827;
      --muted: #6b7280;
      --error: #b91c1c;
      --given: #111827;
      --cell-bg: #ffffff;
      --cell-selected: #2563eb;
      --cell-related: #e5e7eb;
      --same-bg: rgba(37, 99, 235, 0.15);
      --same-border: rgba(37, 99, 235, 0.8);
      --same-text: #1d4ed8;
    }

    body.theme-paper {
      --bg: #fef9c3;
      --card: #fffbeb;
      --accent: #b45309;
      --grid-line: #d97706;
      --grid-sub: #92400e;
      --text: #1f2937;
      --muted: #6b7280;
      --error: #b91c1c;
      --given: #1f2937;
      --cell-bg: #fffbeb;
      --cell-selected: #f59e0b;
      --cell-related: #fef3c7;
      --same-bg: rgba(245, 158, 11, 0.2);
      --same-border: rgba(217, 119, 6, 0.85);
      --same-text: #b45309;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1f2937, #020617 55%);
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 420px;
      padding: 16px;
    }

    .card {
      background: linear-gradient(145deg, var(--card), #030712);
      border-radius: 18px;
      padding: 16px 14px 14px;
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .version {
      font-size: 10px;
      color: var(--muted);
    }

    .controls-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select, button {
      font: inherit;
    }

    .select-wrap {
      flex: 1;
      min-width: 0;
      position: relative;
    }

    .select-wrap select {
      width: 100%;
      padding: 6px 28px 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      font-size: 12px;
      outline: none;
      appearance: none;
    }

    body.theme-bright .select-wrap select,
    body.theme-paper .select-wrap select {
      background: rgba(249, 250, 251, 0.95);
      color: #111827;
    }

    .select-wrap::after {
      content: "‚ñæ";
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--muted);
      pointer-events: none;
    }

    .btn-pill {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 12px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-weight: 600;
      color: #020617;
      background: linear-gradient(135deg, #facc15, #f97316);
      box-shadow:
        0 0 0 1px rgba(250, 204, 21, 0.3),
        0 10px 20px rgba(248, 181, 0, 0.3);
      white-space: nowrap;
    }

    .btn-pill:active {
      transform: translateY(1px);
      box-shadow:
        0 0 0 1px rgba(250, 204, 21, 0.3),
        0 4px 12px rgba(248, 181, 0, 0.4);
    }

    .info-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    body.theme-bright .badge,
    body.theme-paper .badge {
      background: rgba(249, 250, 251, 0.95);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .timer {
      font-variant-numeric: tabular-nums;
    }

    /* GRID */

    .grid-wrap {
      padding: 10px;
      border-radius: 12px;
      background: radial-gradient(circle at top, var(--card), #030712);
      box-shadow: inset 0 0 0 1px rgba(75, 85, 99, 0.3);
      position: relative;
      overflow: hidden;
    }

    body.theme-bright .grid-wrap,
    body.theme-paper .grid-wrap {
      background: var(--card);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.6);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg);
      box-shadow: inset 0 0 0 1px var(--grid-sub);
    }

    .cell {
      width: 100%;
      padding-top: 100%;
      position: relative;
      border: 0;
      background: var(--cell-bg);
      font-size: 18px;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      cursor: pointer;
    }

    .cell-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .cell:nth-child(3n+1) {
      border-left: 1px solid var(--grid-sub);
    }

    .cell:nth-child(-n+9) {
      border-top: 1px solid var(--grid-sub);
    }

    .cell {
      border-right: 1px solid var(--grid-line);
      border-bottom: 1px solid var(--grid-line);
    }

    .cell[data-col="2"],
    .cell[data-col="5"] {
      border-right: 2px solid var(--grid-sub);
    }

    .cell[data-row="2"],
    .cell[data-row="5"] {
      border-bottom: 2px solid var(--grid-sub);
    }

    .cell.given {
      background: var(--cell-bg);
      color: var(--given);
      font-weight: 700;
    }

    .cell.empty {
      color: var(--muted);
    }

    .cell.selected {
      background: linear-gradient(145deg, var(--cell-selected), #0f172a);
      color: #fefce8;
    }

    .cell.related:not(.selected) {
      background: var(--cell-related);
    }

    .cell.same-value:not(.selected) {
      background: var(--same-bg);
      box-shadow: inset 0 0 0 1px var(--same-border);
      color: var(--same-text);
      font-weight: 700;
    }

    .cell.conflict {
      color: var(--error);
      text-shadow: 0 0 6px rgba(248, 113, 113, 0.6);
    }

    .cell:active {
      filter: brightness(1.08);
    }

    /* POPUP PAD */

    .popup-pad {
      position: absolute;
      transform: translate(-50%, -50%);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      padding: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
      z-index: 5;
    }

    body.theme-bright .popup-pad,
    body.theme-paper .popup-pad {
      background: rgba(249, 250, 251, 0.98);
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.9);
    }

    .popup-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: var(--cell-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
    }

    .popup-btn:active {
      transform: translateY(1px);
    }

    /* COMPLETION ANIMATION */

    .anim-overlay {
      position: absolute;
      inset: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 6;
    }

    .anim-tree, .anim-smiley, .anim-star {
      font-size: 64px;
      text-shadow: 0 0 12px rgba(250, 250, 250, 0.7);
      animation: popIn 1.3s ease-out forwards;
    }

    .anim-smiley-text {
      margin-top: 8px;
      font-size: 16px;
      color: var(--accent);
      text-align: center;
      animation: fadeUp 1s ease-out forwards;
    }

    .anim-star span {
      display: inline-block;
      font-size: 40px;
      margin: 0 4px;
      animation: sparkle 1.4s ease-out infinite;
    }

    .anim-confetti {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .anim-confetti-piece {
      position: absolute;
      width: 6px;
      height: 12px;
      border-radius: 999px;
      opacity: 0;
      animation: confettiFall 1.4s ease-out forwards;
    }

    @keyframes popIn {
      0% { transform: scale(0.4); opacity: 0; }
      40% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    @keyframes fadeUp {
      0% { transform: translateY(6px); opacity: 0; }
      40% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-4px); opacity: 0; }
    }

    @keyframes confettiFall {
      0% { transform: translateY(-60px); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translateY(80px); opacity: 0; }
    }

    @keyframes sparkle {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0); opacity: 0; }
    }

    /* PAD */

    .pad {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .pad-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 10px 0;
      font-size: 16px;
      font-weight: 500;
      transition: opacity 0.15s ease;
    }

    body.theme-bright .pad-btn,
    body.theme-paper .pad-btn {
      background: #f9fafb;
      color: #111827;
    }

    .pad-btn.small {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 600;
    }

    .pad-btn.primary {
      border-color: rgba(251, 191, 36, 0.7);
      background: radial-gradient(circle at top, #facc15, #f97316);
      color: #020617;
      font-weight: 700;
      box-shadow:
        0 0 0 1px rgba(250, 204, 21, 0.5),
        0 10px 18px rgba(248, 181, 0, 0.4);
    }

    .pad-btn.toggled {
      background: rgba(37, 99, 235, 0.1);
      border-color: #3b82f6;
      color: #bfdbfe;
    }

    .pad-btn.hidden-num {
      opacity: 0.15;
      pointer-events: none;
    }

    .pad-btn:active {
      transform: translateY(1px);
    }

    .footer {
      margin-top: 10px;
      text-align: center;
      font-size: 10px;
      color: var(--muted);
    }

    .footer b {
      color: var(--accent);
      font-weight: 600;
    }

    .footer a {
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .hidden { display: none !important; }

    /* STATS MODAL */

    .stats-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .stats-modal {
      width: 90%;
      max-width: 420px;
      background: radial-gradient(circle at top, #020617, #020617);
      border-radius: 18px;
      padding: 18px 16px 14px;
      box-shadow:
        0 24px 60px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      font-size: 13px;
    }

    body.theme-bright .stats-modal,
    body.theme-paper .stats-modal {
      background: #f9fafb;
      color: #111827;
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.6),
        0 0 0 1px rgba(148, 163, 184, 0.6);
    }

    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .stats-title {
      font-size: 16px;
      font-weight: 600;
    }

    .stats-version {
      font-size: 11px;
      color: var(--muted);
    }

    .stats-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 6px 0 8px;
      font-size: 12px;
    }

    .stats-table th,
    .stats-table td {
      padding: 4px 2px;
      text-align: center;
    }

    .stats-table th {
      font-weight: 600;
      border-bottom: 1px solid rgba(148, 163, 184, 0.6);
    }

    .stats-table td:first-child,
    .stats-table th:first-child {
      text-align: left;
      padding-left: 4px;
    }

    .stats-footer {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .stats-close {
      display: flex;
      justify-content: flex-end;
    }

    .stats-close button {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 12px;
      padding: 4px 12px;
    }

    body.theme-bright .stats-close button,
    body.theme-paper .stats-close button {
      background: #f9fafb;
      color: #111827;
    }

    @media (max-width: 360px) {
      .card { padding: 12px 10px; }
      .cell { font-size: 16px; }
      .pad-btn { padding: 8px 0; }
      .popup-btn { width: 28px; height: 28px; font-size: 13px; }
    }
  </style>
</head>
<body class="theme-neon">
<div class="app">
  <div class="card">
    <div class="header-row">
      <div class="title-group">
        <h1>Sudoku</h1>
        <div class="subtitle">Ad-free. Just numbers and logic.</div>
        <div class="version">v0.42</div>
      </div>
    </div>

    <div class="controls-row">
      <div class="select-wrap">
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div class="select-wrap">
        <select id="themeSelect">
          <option value="neon" selected>Neon Green</option>
          <option value="neonpink">Neon Pink</option>
          <option value="classic">Classic Dark</option>
          <option value="bright">Bright</option>
          <option value="paper">Paper</option>
        </select>
      </div>
      <div class="select-wrap">
        <select id="animSelect">
          <option value="confetti">Confetti</option>
          <option value="tree">Christmas Tree</option>
          <option value="smiley">Smiley</option>
          <option value="star">Starburst</option>
          <option value="none">No Animation</option>
        </select>
      </div>
      <button id="newGameBtn" class="btn-pill">New Puzzle</button>
    </div>

    <div class="info-row">
      <div class="badge">
        <span class="badge-dot"></span>
        <span id="statusText">In progress</span>
      </div>
      <div class="timer" id="timer">00:00</div>
    </div>

    <div class="grid-wrap">
      <div id="grid" class="grid"></div>

      <!-- popup pad -->
      <div id="popupPad" class="popup-pad hidden">
        <button class="popup-btn" data-num="1">1</button>
        <button class="popup-btn" data-num="2">2</button>
        <button class="popup-btn" data-num="3">3</button>
        <button class="popup-btn" data-num="4">4</button>
        <button class="popup-btn" data-num="5">5</button>
        <button class="popup-btn" data-num="6">6</button>
        <button class="popup-btn" data-num="7">7</button>
        <button class="popup-btn" data-num="8">8</button>
        <button class="popup-btn" data-num="9">9</button>
      </div>

      <!-- completion animation overlay -->
      <div id="animationOverlay" class="anim-overlay hidden"></div>
    </div>

    <div class="pad">
      <button class="pad-btn" data-num="1">1</button>
      <button class="pad-btn" data-num="2">2</button>
      <button class="pad-btn" data-num="3">3</button>
      <button class="pad-btn" data-num="4">4</button>
      <button class="pad-btn" data-num="5">5</button>
      <button class="pad-btn" data-num="6">6</button>
      <button class="pad-btn" data-num="7">7</button>
      <button class="pad-btn" data-num="8">8</button>
      <button class="pad-btn" data-num="9">9</button>
      <button class="pad-btn small" id="eraseBtn">Erase</button>
      <button class="pad-btn small" id="notesBtn">Notes</button>
      <button class="pad-btn small" id="clearNotesBtn">Clr Notes</button>
      <button class="pad-btn small" id="checkBtn">Check</button>
      <button class="pad-btn small" id="undoBtn">Undo</button>
      <button class="pad-btn small primary" id="hintBtn">Hint</button>
    </div>

    <div class="footer">
      Progress is saved locally on this device. <b>No ads. No accounts.</b>
      &nbsp;&middot;&nbsp;
      <a href="#" id="statsLink">Stats</a>
    </div>
  </div>
</div>

<!-- Stats modal -->
<div id="statsOverlay" class="stats-overlay hidden">
  <div class="stats-modal">
    <div class="stats-header">
      <div class="stats-title">Stats</div>
      <div class="stats-version">Version v0.42</div>
    </div>
    <div class="stats-sub" id="statsSub">
      Tracked per difficulty on this device only.
    </div>
    <table class="stats-table">
      <thead>
      <tr>
        <th>Level</th>
        <th>Games</th>
        <th>Best</th>
        <th>Avg</th>
        <th>Worst</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>Easy</td>
        <td id="easyGames">0</td>
        <td id="easyBest">‚Äì</td>
        <td id="easyAvg">‚Äì</td>
        <td id="easyWorst">‚Äì</td>
      </tr>
      <tr>
        <td>Medium</td>
        <td id="medGames">0</td>
        <td id="medBest">‚Äì</td>
        <td id="medAvg">‚Äì</td>
        <td id="medWorst">‚Äì</td>
      </tr>
      <tr>
        <td>Hard</td>
        <td id="hardGames">0</td>
        <td id="hardBest">‚Äì</td>
        <td id="hardAvg">‚Äì</td>
        <td id="hardWorst">‚Äì</td>
      </tr>
      </tbody>
    </table>
    <div class="stats-footer" id="statsFooter">
      Total games: 0 ¬∑ Streak: 0 day(s)
    </div>
    <div class="stats-close">
      <button id="closeStatsBtn">Close</button>
    </div>
  </div>
</div>

<script>
  const PUZZLES = {
    easy: [
      "530070000600195000098000060800060003400803001700020006060000280000419005000080079"
    ],
    medium: [
      "009000010040020000000500400050000000060000009000006030600070000000040090000800300"
    ],
    hard: [
      "800000000003600000070090200050007000000045700000100030001000068008500010090000000"
    ]
  };

  // Game state
  let board = new Array(81).fill(0);
  let given = new Array(81).fill(false);
  let notes = Array.from({ length: 81 }, () => new Set());
  let selectedIndex = null;
  let notesMode = false;

  let currentDifficulty = "easy";
  let currentTheme = "neon";
  let currentAnimation = "confetti";
  let currentPuzzleStr = null;
  let solution = null;

  // timer
  let elapsedSeconds = 0;
  let startTime = null;
  let timerInterval = null;
  let gameFinished = false;

  // errors / hints
  let currentErrors = 0;
  let currentHints = 0;

  // persistent error highlights
  let errorMarks = new Set();

  // undo history
  let history = [];

  // stats
  let stats = {
    easy:   { games: 0, best: null, totalTime: 0, worst: null },
    medium: { games: 0, best: null, totalTime: 0, worst: null },
    hard:   { games: 0, best: null, totalTime: 0, worst: null },
    totalGames: 0,
    streakDays: 0,
    lastPlayDate: null,
    badges: { noHints: 0, noErrors: 0, perfect: 0 }
  };

  // DOM
  const gridEl = document.getElementById("grid");
  const difficultyEl = document.getElementById("difficulty");
  const themeSelect = document.getElementById("themeSelect");
  const animSelect = document.getElementById("animSelect");
  const newGameBtn = document.getElementById("newGameBtn");
  const statusText = document.getElementById("statusText");
  const timerEl = document.getElementById("timer");
  const eraseBtn = document.getElementById("eraseBtn");
  const notesBtn = document.getElementById("notesBtn");
  const clearNotesBtn = document.getElementById("clearNotesBtn");
  const checkBtn = document.getElementById("checkBtn");
  const hintBtn = document.getElementById("hintBtn");
  const undoBtn = document.getElementById("undoBtn");
  const popupPad = document.getElementById("popupPad");
  const padButtons = document.querySelectorAll(".pad-btn[data-num]");
  const statsLink = document.getElementById("statsLink");
  const statsOverlay = document.getElementById("statsOverlay");
  const closeStatsBtn = document.getElementById("closeStatsBtn");
  const animationOverlay = document.getElementById("animationOverlay");

  /* THEME */

  function applyTheme(theme) {
    const themes = ["classic","neon","neonpink","bright","paper"];
    themes.forEach(t => document.body.classList.remove("theme-" + t));
    document.body.classList.add("theme-" + theme);
  }

  const storedTheme = localStorage.getItem("sudokuThemeMain");
  if (storedTheme) {
    currentTheme = storedTheme;
    themeSelect.value = storedTheme;
  }
  applyTheme(currentTheme);

  const storedAnim = localStorage.getItem("sudokuAnimMain");
  if (storedAnim) {
    currentAnimation = storedAnim;
    animSelect.value = storedAnim;
  }

  themeSelect.addEventListener("change", () => {
    currentTheme = themeSelect.value;
    applyTheme(currentTheme);
    saveState();
  });

  animSelect.addEventListener("change", () => {
    currentAnimation = animSelect.value;
    try {
      localStorage.setItem("sudokuAnimMain", currentAnimation);
    } catch (e) {}
  });

  /* UTILS */

  function indexToRC(i) {
    return { row: Math.floor(i / 9), col: i % 9 };
  }

  function rcToIndex(r, c) {
    return r * 9 + c;
  }

  function puzzleStringToBoard(str) {
    const b = new Array(81).fill(0);
    for (let i = 0; i < 81; i++) {
      const c = str[i] || "0";
      b[i] = (c === "0" || c === ".") ? 0 : parseInt(c, 10);
    }
    return b;
  }

  function cloneBoard(b) {
    return b.slice();
  }

  function cloneNotesStruct(n) {
    return n.map(set => new Set(Array.from(set)));
  }

  function formatTime(seconds) {
    if (seconds == null) return "‚Äì";
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    return m + ":" + s;
  }

  function isValidValue(b, index, value) {
    if (value === 0) return true;
    const { row, col } = indexToRC(index);

    // row
    for (let c = 0; c < 9; c++) {
      const idx = rcToIndex(row, c);
      if (idx !== index && b[idx] === value) return false;
    }
    // col
    for (let r = 0; r < 9; r++) {
      const idx = rcToIndex(r, col);
      if (idx !== index && b[idx] === value) return false;
    }
    // box
    const boxRow = Math.floor(row / 3) * 3;
    const boxCol = Math.floor(col / 3) * 3;
    for (let r = 0; r < 3; r++) {
      for (let c = 0; c < 3; c++) {
        const idx = rcToIndex(boxRow + r, boxCol + c);
        if (idx !== index && b[idx] === value) return false;
      }
    }
    return true;
  }

  function isValidPlacement(index, value) {
    return isValidValue(board, index, value);
  }

  /* SOLVER */

  function solveSudoku(initialBoard) {
    const b = cloneBoard(initialBoard);

    function findEmpty() {
      for (let i = 0; i < 81; i++) {
        if (b[i] === 0) return i;
      }
      return -1;
    }

    function solveRec() {
      const idx = findEmpty();
      if (idx === -1) return true;

      for (let num = 1; num <= 9; num++) {
        if (isValidValue(b, idx, num)) {
          b[idx] = num;
          if (solveRec()) return true;
          b[idx] = 0;
        }
      }
      return false;
    }

    if (solveRec()) return b;
    return null;
  }

  /* TIMER */

  function startTimer() {
    gameFinished = false;
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  }

  function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    if (startTime != null) {
      const delta = Math.floor((Date.now() - startTime) / 1000);
      elapsedSeconds += delta;
      startTime = null;
    }
    updateTimer();
  }

  function updateTimer() {
    let total = elapsedSeconds;
    if (startTime != null) {
      total += Math.floor((Date.now() - startTime) / 1000);
    }
    const m = String(Math.floor(total / 60)).padStart(2, "0");
    const s = String(total % 60).padStart(2, "0");
    timerEl.textContent = m + ":" + s;
  }

  function currentElapsedSeconds() {
    let total = elapsedSeconds;
    if (startTime != null) {
      total += Math.floor((Date.now() - startTime) / 1000);
    }
    return total;
  }

  /* HISTORY / UNDO */

  function pushHistory() {
    if (gameFinished) return; // no history once finished
    const running = startTime != null;
    const snapshot = {
      board: board.slice(),
      notes: cloneNotesStruct(notes),
      selectedIndex,
      elapsedSeconds: currentElapsedSeconds(),
      running,
      currentErrors,
      currentHints,
      errorMarks: Array.from(errorMarks)
    };
    history.push(snapshot);
    if (history.length > 100) history.shift();
  }

  function handleUndo() {
    if (history.length === 0) return;
    if (gameFinished) return;

    const snap = history.pop();
    board = snap.board.slice();
    notes = snap.notes.map(s => new Set(Array.from(s)));
    selectedIndex = snap.selectedIndex;
    elapsedSeconds = snap.elapsedSeconds;
    currentErrors = snap.currentErrors;
    currentHints = snap.currentHints;
    errorMarks = new Set(snap.errorMarks || []);

    if (timerInterval) clearInterval(timerInterval);
    if (snap.running) {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    } else {
      startTime = null;
    }
    updateTimer();
    statusText.textContent = "Undo";
    saveState();
    render();
  }

  /* STATS LOAD/SAVE */

  function loadStats() {
    try {
      const raw = localStorage.getItem("sudokuStatsV1");
      if (!raw) return;
      const obj = JSON.parse(raw);
      stats = Object.assign(stats, obj);
    } catch (e) {}
  }

  function saveStats() {
    try {
      localStorage.setItem("sudokuStatsV1", JSON.stringify(stats));
    } catch (e) {}
  }

  function formatStatsTime(seconds, games) {
    return games ? formatTime(Math.round(seconds / games)) : "‚Äì";
  }

  function updateStatsUI() {
    const easy = stats.easy;
    const med  = stats.medium;
    const hard = stats.hard;

    document.getElementById("easyGames").textContent = easy.games;
    document.getElementById("easyBest").textContent  = formatTime(easy.best);
    document.getElementById("easyAvg").textContent   = formatStatsTime(easy.totalTime, easy.games);
    document.getElementById("easyWorst").textContent = formatTime(easy.worst);

    document.getElementById("medGames").textContent = med.games;
    document.getElementById("medBest").textContent  = formatTime(med.best);
    document.getElementById("medAvg").textContent   = formatStatsTime(med.totalTime, med.games);
    document.getElementById("medWorst").textContent = formatTime(med.worst);

    document.getElementById("hardGames").textContent = hard.games;
    document.getElementById("hardBest").textContent  = formatTime(hard.best);
    document.getElementById("hardAvg").textContent   = formatStatsTime(hard.totalTime, hard.games);
    document.getElementById("hardWorst").textContent = formatTime(hard.worst);

    const badges = stats.badges;
    const sub = `Tracked per difficulty on this device only.
Badges ‚Äì No Hints: ${badges.noHints} ¬∑ No Errors: ${badges.noErrors} ¬∑ Perfect: ${badges.perfect}`;
    document.getElementById("statsSub").textContent = sub;

    const footer = `Total games: ${stats.totalGames} ¬∑ Streak: ${stats.streakDays} day(s) (Best: ${stats.streakDays})`;
    document.getElementById("statsFooter").textContent = footer;
  }

  function recordGameResult() {
    const diffKey = currentDifficulty;
    const diffStats = stats[diffKey];
    const time = currentElapsedSeconds();

    diffStats.games += 1;
    diffStats.totalTime += time;
    if (diffStats.best == null || time < diffStats.best) diffStats.best = time;
    if (diffStats.worst == null || time > diffStats.worst) diffStats.worst = time;

    stats.totalGames += 1;

    const today = new Date();
    const todayKey = today.getFullYear() + "-" +
      String(today.getMonth()+1).padStart(2,"0") + "-" +
      String(today.getDate()).padStart(2,"0");

    if (!stats.lastPlayDate) {
      stats.streakDays = 1;
    } else if (stats.lastPlayDate === todayKey) {
      // same day, streak unchanged
    } else {
      const last = new Date(stats.lastPlayDate + "T00:00:00");
      const diffMs = today - last;
      const diffDays = Math.round(diffMs / 86400000);
      if (diffDays === 1) stats.streakDays += 1;
      else stats.streakDays = 1;
    }

    stats.lastPlayDate = todayKey;

    const noHints = currentHints === 0;
    const noErrors = currentErrors === 0;
    if (noHints) stats.badges.noHints += 1;
    if (noErrors) stats.badges.noErrors += 1;
    if (noHints && noErrors) stats.badges.perfect += 1;

    saveStats();
  }

  /* COMPLETION ANIMATION */

  function playCompletionAnimation() {
    if (currentAnimation === "none") return;
    animationOverlay.classList.remove("hidden");
    animationOverlay.innerHTML = "";

    if (currentAnimation === "tree") {
      const c = document.createElement("div");
      c.className = "anim-tree";
      c.textContent = "üéÑ";
      animationOverlay.appendChild(c);
    } else if (currentAnimation === "smiley") {
      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.flexDirection = "column";
      wrap.style.alignItems = "center";
      const face = document.createElement("div");
      face.className = "anim-smiley";
      face.textContent = "üòä";
      const text = document.createElement("div");
      text.className = "anim-smiley-text";
      text.textContent = "Nice solve!";
      wrap.appendChild(face);
      wrap.appendChild(text);
      animationOverlay.appendChild(wrap);
    } else if (currentAnimation === "star") {
      const starWrap = document.createElement("div");
      starWrap.className = "anim-star";
      const s1 = document.createElement("span");
      const s2 = document.createElement("span");
      const s3 = document.createElement("span");
      s1.textContent = "‚≠ê";
      s2.textContent = "üåü";
      s3.textContent = "‚≠ê";
      s2.style.animationDelay = "0.2s";
      s3.style.animationDelay = "0.4s";
      starWrap.appendChild(s1);
      starWrap.appendChild(s2);
      starWrap.appendChild(s3);
      animationOverlay.appendChild(starWrap);
    } else if (currentAnimation === "confetti") {
      const conf = document.createElement("div");
      conf.className = "anim-confetti";
      const colors = ["#facc15","#22c55e","#38bdf8","#f97316","#e879f9"];
      for (let i = 0; i < 40; i++) {
        const p = document.createElement("div");
        p.className = "anim-confetti-piece";
        const left = Math.random() * 100;
        const delay = Math.random() * 0.4;
        const dur = 1 + Math.random() * 0.6;
        p.style.left = left + "%";
        p.style.top = (Math.random() * 20 - 10) + "%";
        p.style.backgroundColor = colors[i % colors.length];
        p.style.animationDuration = dur + "s";
        p.style.animationDelay = delay + "s";
        conf.appendChild(p);
      }
      animationOverlay.appendChild(conf);
    }

    setTimeout(() => {
      animationOverlay.classList.add("hidden");
      animationOverlay.innerHTML = "";
    }, 1600);
  }

  function finishGame() {
    if (gameFinished) return;
    gameFinished = true;
    stopTimer();
    statusText.textContent = "Completed üéâ";
    recordGameResult();
    playCompletionAnimation();
  }

  /* STATE SAVE/LOAD */

  function saveState() {
    try {
      const state = {
        board,
        given,
        notes: notes.map(s => Array.from(s)),
        difficulty: currentDifficulty,
        theme: currentTheme,
        puzzle: currentPuzzleStr,
        elapsedSeconds,
        running: startTime != null && !gameFinished
      };
      localStorage.setItem("sudokuStateMainV2", JSON.stringify(state));
      localStorage.setItem("sudokuThemeMain", currentTheme);
    } catch (e) {}
  }

  function loadState() {
    try {
      const raw = localStorage.getItem("sudokuStateMainV2");
      if (!raw) return false;
      const state = JSON.parse(raw);
      board = state.board || board;
      given = state.given || given;
      notes = (state.notes || []).map(arr => new Set(arr));
      currentDifficulty = state.difficulty || "easy";
      currentTheme = state.theme || "neon";
      currentPuzzleStr = state.puzzle || null;
      elapsedSeconds = state.elapsedSeconds || 0;

      difficultyEl.value = currentDifficulty;
      themeSelect.value = currentTheme;
      applyTheme(currentTheme);

      if (currentPuzzleStr) {
        const base = puzzleStringToBoard(currentPuzzleStr);
        solution = solveSudoku(base);
      }

      history = [];
      errorMarks = new Set();
      currentErrors = 0;
      currentHints = 0;
      gameFinished = false;

      if (state.running) {
        startTime = Date.now();
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
      } else {
        startTime = null;
      }
      updateTimer();
      statusText.textContent = "Resumed game";
      return true;
    } catch (e) {
      return false;
    }
  }

  /* PUZZLE INIT */

  function loadRandomPuzzle(diff) {
    const arr = PUZZLES[diff];
    const puzzle = arr[Math.floor(Math.random() * arr.length)];
    currentPuzzleStr = puzzle;

    const base = puzzleStringToBoard(puzzle);
    board = cloneBoard(base);
    given = new Array(81).fill(false);
    notes = Array.from({ length: 81 }, () => new Set());

    for (let i = 0; i < 81; i++) {
      if (base[i] !== 0) given[i] = true;
    }

    solution = solveSudoku(base);
    selectedIndex = null;
    notesMode = false;
    notesBtn.classList.remove("toggled");
    elapsedSeconds = 0;
    startTimer();
    currentErrors = 0;
    currentHints = 0;
    gameFinished = false;
    errorMarks = new Set();
    history = [];
    statusText.textContent = "In progress";
    hidePopupPad();
    saveState();
    render();
  }

  /* LOGIC HELPERS */

  function findRuleConflicts() {
    const conflicts = new Set();

    // rows
    for (let r = 0; r < 9; r++) {
      const seen = {};
      for (let c = 0; c < 9; c++) {
        const idx = rcToIndex(r, c);
        const v = board[idx];
        if (!v) continue;
        if (seen[v] !== undefined) {
          conflicts.add(idx);
          conflicts.add(seen[v]);
        } else {
          seen[v] = idx;
        }
      }
    }

    // cols
    for (let c = 0; c < 9; c++) {
      const seen = {};
      for (let r = 0; r < 9; r++) {
        const idx = rcToIndex(r, c);
        const v = board[idx];
        if (!v) continue;
        if (seen[v] !== undefined) {
          conflicts.add(idx);
          conflicts.add(seen[v]);
        } else {
          seen[v] = idx;
        }
      }
    }

    // boxes
    for (let br = 0; br < 3; br++) {
      for (let bc = 0; bc < 3; bc++) {
        const seen = {};
        for (let r = 0; r < 3; r++) {
          for (let c = 0; c < 3; c++) {
            const idx = rcToIndex(br * 3 + r, bc * 3 + c);
            const v = board[idx];
            if (!v) continue;
            if (seen[v] !== undefined) {
              conflicts.add(idx);
              conflicts.add(seen[v]);
            } else {
              seen[v] = idx;
            }
          }
        }
      }
    }

    return conflicts;
  }

  function clearDigitFromPeers(index, digit) {
    const { row, col } = indexToRC(index);

    // row
    for (let c = 0; c < 9; c++) {
      const idx = rcToIndex(row, c);
      if (idx !== index) notes[idx].delete(digit);
    }
    // col
    for (let r = 0; r < 9; r++) {
      const idx = rcToIndex(r, col);
      if (idx !== index) notes[idx].delete(digit);
    }
    // box
    const boxRow = Math.floor(row / 3) * 3;
    const boxCol = Math.floor(col / 3) * 3;
    for (let r = 0; r < 3; r++) {
      for (let c = 0; c < 3; c++) {
        const idx = rcToIndex(boxRow + r, boxCol + c);
        if (idx !== index) notes[idx].delete(digit);
      }
    }
  }

  function isSolvedCompletely() {
    for (let i = 0; i < 81; i++) {
      if (board[i] === 0) return false;
    }
    const conflicts = findRuleConflicts();
    return conflicts.size === 0 && (!solution || board.every((v, i) => v === solution[i]));
  }

  /* POPUP PAD */

  function hidePopupPad() {
    popupPad.classList.add("hidden");
  }

  function showPopupPad(cellEl) {
    const gridRect = gridEl.getBoundingClientRect();
    const cellRect = cellEl.getBoundingClientRect();
    const x = cellRect.left + cellRect.width / 2 - gridRect.left;
    const y = cellRect.top + cellRect.height / 2 - gridRect.top;
    popupPad.style.left = x + "px";
    popupPad.style.top = y + "px";
    popupPad.classList.remove("hidden");
  }

  gridEl.addEventListener("click", (e) => {
    if (!popupPad.contains(e.target) && !e.target.classList.contains("cell")) {
      hidePopupPad();
    }
  });

  /* INPUT HANDLERS */

  function handleCellTap(index, cellEl) {
    selectedIndex = index;
    const editableBlank = !given[index] && board[index] === 0;
    render();
    if (editableBlank && !notesMode && cellEl) {
      showPopupPad(cellEl);
    } else {
      hidePopupPad();
    }
  }

  function handleNumberTap(num) {
    if (selectedIndex === null) return;
    if (given[selectedIndex]) return;
    if (gameFinished) return;

    const idx = selectedIndex;

    if (notesMode) {
      pushHistory();
      const set = notes[idx];
      if (set.has(num)) set.delete(num);
      else set.add(num);
      board[idx] = 0;
      errorMarks.delete(idx);
      statusText.textContent = "Notes updated";
      hidePopupPad();
      saveState();
      render();
      return;
    }

    // check legality without changing board
    if (!isValidPlacement(idx, num)) {
      currentErrors += 1;
      statusText.textContent = "That breaks row / column / box.";
      errorMarks.add(idx);
      const conflicts = findRuleConflicts();
      render(conflicts);
      return;
    }

    pushHistory();
    board[idx] = num;
    notes[idx].clear();
    clearDigitFromPeers(idx, num);
    errorMarks.delete(idx);

    if (isSolvedCompletely()) {
      finishGame();
    } else {
      statusText.textContent = "In progress";
    }

    hidePopupPad();
    saveState();
    render();
  }

  function handleErase() {
    if (selectedIndex === null) return;
    if (given[selectedIndex]) return;
    if (gameFinished) return;
    pushHistory();
    board[selectedIndex] = 0;
    notes[selectedIndex].clear();
    errorMarks.delete(selectedIndex);
    statusText.textContent = "In progress";
    hidePopupPad();
    saveState();
    render();
  }

  function handleCheck() {
    if (gameFinished) return;
    const ruleConflicts = findRuleConflicts();
    const allConflicts = new Set(ruleConflicts);

    if (solution) {
      for (let i = 0; i < 81; i++) {
        if (board[i] !== 0 && board[i] !== solution[i]) {
          allConflicts.add(i);
        }
      }
    }

    if (allConflicts.size === 0) {
      statusText.textContent = "No conflicts so far ‚úÖ";
    } else {
      statusText.textContent = `${allConflicts.size} issue(s) found ‚ùó`;
      currentErrors += 1;
    }

    errorMarks = new Set(allConflicts);
    render(allConflicts);
  }

  function handleHint() {
    if (selectedIndex === null || given[selectedIndex]) return;
    if (board[selectedIndex] !== 0) return;
    if (gameFinished) return;

    if (solution) {
      pushHistory();
      const val = solution[selectedIndex];
      board[selectedIndex] = val;
      notes[selectedIndex].clear();
      clearDigitFromPeers(selectedIndex, val);
      errorMarks.delete(selectedIndex);
      currentHints += 1;
      statusText.textContent = "Hint applied üí°";
      if (isSolvedCompletely()) {
        finishGame();
      }
      hidePopupPad();
      saveState();
      render();
    }
  }

  function toggleNotesMode() {
    notesMode = !notesMode;
    notesBtn.classList.toggle("toggled", notesMode);
    hidePopupPad();
    render();
  }

  function clearNotes() {
    if (selectedIndex === null) return;
    if (gameFinished) return;
    if (notes[selectedIndex].size === 0) return;
    pushHistory();
    notes[selectedIndex].clear();
    errorMarks.delete(selectedIndex);
    saveState();
    render();
  }

  /* RENDERING */

  function updatePadVisibility() {
    const counts = Array(10).fill(0);
    for (let i = 0; i < 81; i++) {
      const v = board[i];
      if (v) counts[v]++;
    }
    padButtons.forEach(btn => {
      const num = parseInt(btn.dataset.num, 10);
      if (!notesMode && counts[num] >= 9) {
        btn.classList.add("hidden-num");
      } else {
        btn.classList.remove("hidden-num");
      }
    });
  }

  function render(conflictsOverride) {
    gridEl.innerHTML = "";
    const baseConflicts = conflictsOverride || findRuleConflicts();
    const conflicts = new Set(baseConflicts);
    errorMarks.forEach(i => conflicts.add(i));

    const selectedVal = selectedIndex !== null ? board[selectedIndex] : null;

    for (let i = 0; i < 81; i++) {
      const cell = document.createElement("button");
      cell.className = "cell";
      const { row, col } = indexToRC(i);
      cell.dataset.row = row;
      cell.dataset.col = col;

      const inner = document.createElement("div");
      inner.className = "cell-inner";

      if (given[i]) {
        cell.classList.add("given");
      } else if (board[i] === 0 && notes[i].size === 0) {
        cell.classList.add("empty");
      }

      if (board[i] !== 0) {
        inner.textContent = board[i];
      } else if (notes[i].size > 0) {
        const small = document.createElement("div");
        small.style.fontSize = "11px";
        small.style.lineHeight = "1.1";
        small.style.opacity = "0.9";
        small.style.display = "grid";
        small.style.gridTemplateColumns = "repeat(3, 1fr)";
        small.style.width = "95%";
        small.style.height = "95%";
        for (let n = 1; n <= 9; n++) {
          const span = document.createElement("span");
          span.style.fontSize = "10px";
          span.style.opacity = notes[i].has(n) ? "1" : "0.18";
          span.textContent = notes[i].has(n) ? n : " ";
          small.appendChild(span);
        }
        inner.appendChild(small);
      } else {
        inner.textContent = "";
      }

      if (i === selectedIndex) {
        cell.classList.add("selected");
      } else if (selectedIndex !== null) {
        const { row: sr, col: sc } = indexToRC(selectedIndex);
        if (row === sr || col === sc ||
            (Math.floor(row / 3) === Math.floor(sr / 3) &&
             Math.floor(col / 3) === Math.floor(sc / 3))) {
          cell.classList.add("related");
        }
      }

      if (selectedVal && board[i] === selectedVal && i !== selectedIndex) {
        cell.classList.add("same-value");
      }

      if (conflicts.has(i)) {
        cell.classList.add("conflict");
      }

      cell.addEventListener("click", (evt) => handleCellTap(i, evt.currentTarget));
      cell.appendChild(inner);
      gridEl.appendChild(cell);
    }

    updatePadVisibility();
  }

  /* EVENTS */

  difficultyEl.addEventListener("change", () => {
    currentDifficulty = difficultyEl.value;
    saveState();
  });

  newGameBtn.addEventListener("click", () => {
    loadRandomPuzzle(currentDifficulty);
  });

  padButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const num = parseInt(btn.dataset.num, 10);
      handleNumberTap(num);
    });
  });

  popupPad.querySelectorAll(".popup-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const num = parseInt(btn.dataset.num, 10);
      handleNumberTap(num);
    });
  });

  eraseBtn.addEventListener("click", handleErase);
  notesBtn.addEventListener("click", toggleNotesMode);
  clearNotesBtn.addEventListener("click", clearNotes);
  checkBtn.addEventListener("click", handleCheck);
  hintBtn.addEventListener("click", handleHint);
  undoBtn.addEventListener("click", handleUndo);

  statsLink.addEventListener("click", (e) => {
    e.preventDefault();
    updateStatsUI();
    statsOverlay.classList.remove("hidden");
  });

  closeStatsBtn.addEventListener("click", () => {
    statsOverlay.classList.add("hidden");
  });

  statsOverlay.addEventListener("click", (e) => {
    if (e.target === statsOverlay) {
      statsOverlay.classList.add("hidden");
    }
  });

  /* INIT */

  loadStats();

  if (!loadState()) {
    loadRandomPuzzle(currentDifficulty);
  } else {
    render();
  }
</script>
</body>
</html>
