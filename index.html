<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sudoku ‚Äì Your Ad-Free App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --bg: #111827;
      --card: #020617;
      --accent: #fbbf24;
      --grid-line: #374151;
      --grid-sub: #4b5563;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #f97373;
      --given: #e5e7eb;
      --cell-bg: #020617;
      --cell-selected: #1d4ed8;
      --cell-related: #020617;
      --same-bg: rgba(250, 204, 21, 0.18);
      --same-border: rgba(250, 204, 21, 0.7);
      --same-text: #facc15;
    }

    /* THEMES */
    body.theme-classic {
      --bg: #111827;
      --card: #020617;
      --accent: #fbbf24;
      --grid-line: #374151;
      --grid-sub: #4b5563;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #f97373;
      --given: #e5e7eb;
      --cell-bg: #020617;
      --cell-selected: #1d4ed8;
      --cell-related: #020617;
      --same-bg: rgba(250, 204, 21, 0.18);
      --same-border: rgba(250, 204, 21, 0.7);
      --same-text: #facc15;
    }

    body.theme-neon {
      --bg: #020617;
      --card: #020617;
      --accent: #22c55e;
      --grid-line: #22c55e;
      --grid-sub: #4ade80;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #fb7185;
      --given: #f9fafb;
      --cell-bg: #020617;
      --cell-selected: #22c55e;
      --cell-related: #020617;
      --same-bg: rgba(34, 197, 94, 0.18);
      --same-border: rgba(34, 197, 94, 0.7);
      --same-text: #4ade80;
    }

    body.theme-neonpink {
      --bg: #020617;
      --card: #020617;
      --accent: #ec4899;
      --grid-line: #ec4899;
      --grid-sub: #fb7185;
      --text: #f9fafb;
      --muted: #e5e7eb;
      --error: #fb7185;
      --given: #fdf2f8;
      --cell-bg: #020617;
      --cell-selected: #ec4899;
      --cell-related: #020617;
      --same-bg: rgba(236, 72, 153, 0.2);
      --same-border: rgba(236, 72, 153, 0.85);
      --same-text: #fb7185;
    }

    body.theme-bright {
      --bg: #e5e7eb;
      --card: #f9fafb;
      --accent: #2563eb;
      --grid-line: #d1d5db;
      --grid-sub: #9ca3af;
      --text: #111827;
      --muted: #6b7280;
      --error: #b91c1c;
      --given: #111827;
      --cell-bg: #ffffff;
      --cell-selected: #2563eb;
      --cell-related: #e5e7eb;
      --same-bg: rgba(37, 99, 235, 0.15);
      --same-border: rgba(37, 99, 235, 0.8);
      --same-text: #1d4ed8;
    }

    body.theme-paper {
      --bg: #fef9c3;
      --card: #fffbeb;
      --accent: #b45309;
      --grid-line: #d97706;
      --grid-sub: #92400e;
      --text: #1f2937;
      --muted: #6b7280;
      --error: #b91c1c;
      --given: #1f2937;
      --cell-bg: #fffbeb;
      --cell-selected: #f59e0b;
      --cell-related: #fef3c7;
      --same-bg: rgba(245, 158, 11, 0.2);
      --same-border: rgba(217, 119, 6, 0.85);
      --same-text: #b45309;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1f2937, #020617 55%);
      color: var(--text);
    }

    .app {
      width: 100%;
      max-width: 420px;
      padding: 16px;
    }

    .card {
      background: linear-gradient(145deg, var(--card), #030712);
      border-radius: 18px;
      padding: 16px 14px 14px;
      box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    .controls-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select, button {
      font: inherit;
    }

    .select-wrap {
      flex: 1;
      min-width: 0;
      position: relative;
    }

    .select-wrap select {
      width: 100%;
      padding: 6px 28px 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      font-size: 12px;
      outline: none;
      appearance: none;
    }

    body.theme-bright .select-wrap select,
    body.theme-paper .select-wrap select {
      background: rgba(249, 250, 251, 0.95);
      color: #111827;
    }

    .select-wrap::after {
      content: "‚ñæ";
      position: absolute;
      right: 9px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: var(--muted);
      pointer-events: none;
    }

    .btn-pill {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 12px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-weight: 600;
      color: #020617;
      background: linear-gradient(135deg, #facc15, #f97316);
      box-shadow:
        0 0 0 1px rgba(250, 204, 21, 0.3),
        0 10px 20px rgba(248, 181, 0, 0.3);
      white-space: nowrap;
    }

    .btn-pill:active {
      transform: translateY(1px);
      box-shadow:
        0 0 0 1px rgba(250, 204, 21, 0.3),
        0 4px 12px rgba(248, 181, 0, 0.4);
    }

    .info-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    body.theme-bright .badge,
    body.theme-paper .badge {
      background: rgba(249, 250, 251, 0.95);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .timer {
      font-variant-numeric: tabular-nums;
    }

    /* GRID */

    .grid-wrap {
      padding: 10px;
      border-radius: 12px;
      background: radial-gradient(circle at top, var(--card), #030712);
      box-shadow: inset 0 0 0 1px rgba(75, 85, 99, 0.3);
      position: relative;
    }

    body.theme-bright .grid-wrap,
    body.theme-paper .grid-wrap {
      background: var(--card);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.6);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg);
      box-shadow: inset 0 0 0 1px var(--grid-sub);
    }

    .cell {
      width: 100%;
      padding-top: 100%;
      position: relative;
      border: 0;
      background: var(--cell-bg);
      font-size: 18px;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      cursor: pointer;
    }

    .cell-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .cell:nth-child(3n+1) {
      border-left: 1px solid var(--grid-sub);
    }

    .cell:nth-child(-n+9) {
      border-top: 1px solid var(--grid-sub);
    }

    .cell {
      border-right: 1px solid var(--grid-line);
      border-bottom: 1px solid var(--grid-line);
    }

    .cell[data-col="2"],
    .cell[data-col="5"] {
      border-right: 2px solid var(--grid-sub);
    }

    .cell[data-row="2"],
    .cell[data-row="5"] {
      border-bottom: 2px solid var(--grid-sub);
    }

    .cell.given {
      background: var(--cell-bg);
      color: var(--given);
      font-weight: 700;
    }

    .cell.empty {
      color: var(--muted);
    }

    .cell.selected {
      background: linear-gradient(145deg, var(--cell-selected), #0f172a);
      color: #fefce8;
    }

    .cell.related:not(.selected) {
      background: var(--cell-related);
    }

    .cell.same-value:not(.selected) {
      background: var(--same-bg);
      box-shadow: inset 0 0 0 1px var(--same-border);
      color: var(--same-text);
      font-weight: 700;
    }

    .cell.conflict {
      color: var(--error);
      text-shadow: 0 0 6px rgba(248, 113, 113, 0.6);
    }

    .cell:active {
      filter: brightness(1.08);
    }

    /* POPUP PAD */

    .popup-pad {
      position: absolute;
      transform: translate(-50%, -50%);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      padding: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
      z-index: 5;
    }

    body.theme-bright .popup-pad,
    body.theme-paper .popup-pad {
      background: rgba(249, 250, 251, 0.98);
      box-shadow: 0 10px 25px rgba(148, 163, 184, 0.9);
    }

    .popup-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: var(--cell-bg);
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
    }

    .popup-btn:active {
      transform: translateY(1px);
    }

    /* PAD */

    .pad {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }

    .pad-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 10px 0;
      font-size: 16px;
      font-weight: 500;
      transition: opacity 0.15s ease;
    }

    body.theme-bright .pad-btn,
    body.theme-paper .pad-btn {
      background: #f9fafb;
      color: #111827;
    }

    .pad-btn.small {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-weight: 600;
    }

    .pad-btn.primary {
      border-color: rgba(251, 191, 36, 0.7);
      background: radial-gradient(circle at top, #facc15, #f97316);
      color: #020617;
      font-weight: 700;
      box-shadow:
        0 0 0 1px rgba(250, 204, 21, 0.5),
        0 10px 18px rgba(248, 181, 0, 0.4);
    }

    .pad-btn.toggled {
      background: rgba(37, 99, 235, 0.1);
      border-color: #3b82f6;
      color: #bfdbfe;
    }

    .pad-btn.hidden-num {
      opacity: 0.15;
      pointer-events: none;
    }

    .pad-btn:active {
      transform: translateY(1px);
    }

    .footer {
      margin-top: 10px;
      text-align: center;
      font-size: 10px;
      color: var(--muted);
    }

    .footer b {
      color: var(--accent);
      font-weight: 600;
    }

    .hidden { display: none !important; }

    @media (max-width: 360px) {
      .card { padding: 12px 10px; }
      .cell { font-size: 16px; }
      .pad-btn { padding: 8px 0; }
      .popup-btn { width: 28px; height: 28px; font-size: 13px; }
    }
  </style>
</head>
<body class="theme-neon">
<div class="app">
  <div class="card">
    <div class="header-row">
      <div class="title-group">
        <h1>Sudoku</h1>
        <div class="subtitle">Ad-free. Just numbers and logic.</div>
      </div>
    </div>

    <div class="controls-row">
      <div class="select-wrap">
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div class="select-wrap">
        <select id="themeSelect">
          <option value="neon" selected>Neon Green</option>
          <option value="neonpink">Neon Pink</option>
          <option value="classic">Classic Dark</option>
          <option value="bright">Bright</option>
          <option value="paper">Paper</option>
        </select>
      </div>
      <button id="newGameBtn" class="btn-pill">New Puzzle</button>
    </div>

    <div class="info-row">
      <div class="badge">
        <span class="badge-dot"></span>
        <span id="statusText">In progress</span>
      </div>
      <div class="timer" id="timer">00:00</div>
    </div>

    <div class="grid-wrap">
      <div id="grid" class="grid"></div>

      <!-- popup pad -->
      <div id="popupPad" class="popup-pad hidden">
        <button class="popup-btn" data-num="1">1</button>
        <button class="popup-btn" data-num="2">2</button>
        <button class="popup-btn" data-num="3">3</button>
        <button class="popup-btn" data-num="4">4</button>
        <button class="popup-btn" data-num="5">5</button>
        <button class="popup-btn" data-num="6">6</button>
        <button class="popup-btn" data-num="7">7</button>
        <button class="popup-btn" data-num="8">8</button>
        <button class="popup-btn" data-num="9">9</button>
      </div>
    </div>

    <div class="pad">
      <button class="pad-btn" data-num="1">1</button>
      <button class="pad-btn" data-num="2">2</button>
      <button class="pad-btn" data-num="3">3</button>
      <button class="pad-btn" data-num="4">4</button>
      <button class="pad-btn" data-num="5">5</button>
      <button class="pad-btn" data-num="6">6</button>
      <button class="pad-btn" data-num="7">7</button>
      <button class="pad-btn" data-num="8">8</button>
      <button class="pad-btn" data-num="9">9</button>
      <button class="pad-btn small" id="eraseBtn">Erase</button>
      <button class="pad-btn small" id="notesBtn">Notes</button>
      <button class="pad-btn small" id="clearNotesBtn">Clr Notes</button>
      <button class="pad-btn small" id="checkBtn">Check</button>
      <button class="pad-btn small primary" id="hintBtn">Hint</button>
    </div>

    <div class="footer">
      Progress is saved locally on this device. <b>No ads. No accounts.</b>
    </div>
  </div>
</div>

<script>
  // Puzzles (0 = empty). We'll add more / generator later.
  const PUZZLES = {
    easy: [
      "530070000600195000098000060800060003400803001700020006060000280000419005000080079"
    ],
    medium: [
      "009000010040020000000500400050000000060000009000006030600070000000040090000800300"
    ],
    hard: [
      "800000000003600000070090200050007000000045700000100030001000068008500010090000000"
    ]
  };

  let board = new Array(81).fill(0);
  let given = new Array(81).fill(false);
  let notes = Array.from({ length: 81 }, () => new Set());
  let selectedIndex = null;
  let notesMode = false;
  let startTime = null;
  let timerInterval = null;
  let currentDifficulty = "easy";
  let currentTheme = "neon";
  let currentPuzzleStr = null;
  let solution = null;

  const gridEl = document.getElementById("grid");
  const difficultyEl = document.getElementById("difficulty");
  const themeSelect = document.getElementById("themeSelect");
  const newGameBtn = document.getElementById("newGameBtn");
  const statusText = document.getElementById("statusText");
  const timerEl = document.getElementById("timer");
  const eraseBtn = document.getElementById("eraseBtn");
  const notesBtn = document.getElementById("notesBtn");
  const clearNotesBtn = document.getElementById("clearNotesBtn");
  const checkBtn = document.getElementById("checkBtn");
  const hintBtn = document.getElementById("hintBtn");
  const popupPad = document.getElementById("popupPad");
  const padButtons = document.querySelectorAll(".pad-btn[data-num]");

  /* THEME */

  function applyTheme(theme) {
    const classes = ["classic","neon","neonpink","bright","paper"];
    classes.forEach(t => document.body.classList.remove("theme-" + t));
    document.body.classList.add("theme-" + theme);
  }

  const savedTheme = localStorage.getItem("sudokuThemeV1");
  if (savedTheme) {
    currentTheme = savedTheme;
    themeSelect.value = savedTheme;
    applyTheme(savedTheme);
  } else {
    applyTheme(currentTheme);
  }

  themeSelect.addEventListener("change", () => {
    currentTheme = themeSelect.value;
    applyTheme(currentTheme);
    saveState();
  });

  /* UTILS */

  function indexToRC(i) {
    return { row: Math.floor(i / 9), col: i % 9 };
  }

  function rcToIndex(r, c) {
    return r * 9 + c;
  }

  function puzzleStringToBoard(str) {
    const b = new Array(81).fill(0);
    for (let i = 0; i < 81; i++) {
      const c = str[i] || "0";
      b[i] = (c === "0" || c === ".") ? 0 : parseInt(c, 10);
    }
    return b;
  }

  function cloneBoard(b) {
    return b.slice();
  }

  function isValidValue(b, index, value) {
    if (value === 0) return true;
    const { row, col } = indexToRC(index);

    // row
    for (let c = 0; c < 9; c++) {
      const idx = rcToIndex(row, c);
      if (idx !== index && b[idx] === value) return false;
    }
    // col
    for (let r = 0; r < 9; r++) {
      const idx = rcToIndex(r, col);
      if (idx !== index && b[idx] === value) return false;
    }
    // box
    const boxRow = Math.floor(row / 3) * 3;
    const boxCol = Math.floor(col / 3) * 3;
    for (let r = 0; r < 3; r++) {
      for (let c = 0; c < 3; c++) {
        const idx = rcToIndex(boxRow + r, boxCol + c);
        if (idx !== index && b[idx] === value) return false;
      }
    }
    return true;
  }

  function isValidPlacement(index, value) {
    return isValidValue(board, index, value);
  }

  /* SOLVER (for Check / Hints, and later "no mistakes" mode if you want) */

  function solveSudoku(initialBoard) {
    const b = cloneBoard(initialBoard);

    function findEmpty() {
      for (let i = 0; i < 81; i++) {
        if (b[i] === 0) return i;
      }
      return -1;
    }

    function solveRec() {
      const idx = findEmpty();
      if (idx === -1) return true;

      for (let num = 1; num <= 9; num++) {
        if (isValidValue(b, idx, num)) {
          b[idx] = num;
          if (solveRec()) return true;
          b[idx] = 0;
        }
      }
      return false;
    }

    if (solveRec()) return b;
    return null;
  }

  /* TIMER */

  function startTimer() {
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  }

  function updateTimer() {
    if (!startTime) {
      timerEl.textContent = "00:00";
      return;
    }
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, "0");
    const s = String(elapsed % 60).padStart(2, "0");
    timerEl.textContent = m + ":" + s;
  }

  /* STATE LOAD/SAVE */

  function saveState() {
    try {
      const state = {
        board,
        given,
        notes: notes.map(s => Array.from(s)),
        difficulty: currentDifficulty,
        theme: currentTheme,
        puzzle: currentPuzzleStr,
        startTime
      };
      localStorage.setItem("sudokuStateMain", JSON.stringify(state));
      localStorage.setItem("sudokuThemeV1", currentTheme);
    } catch (e) {}
  }

  function loadState() {
    try {
      const raw = localStorage.getItem("sudokuStateMain");
      if (!raw) return false;
      const state = JSON.parse(raw);
      board = state.board || board;
      given = state.given || given;
      notes = (state.notes || []).map(arr => new Set(arr));
      currentDifficulty = state.difficulty || "easy";
      currentPuzzleStr = state.puzzle || null;
      currentTheme = state.theme || "neon";

      difficultyEl.value = currentDifficulty;
      themeSelect.value = currentTheme;
      applyTheme(currentTheme);

      if (currentPuzzleStr) {
        const base = puzzleStringToBoard(currentPuzzleStr);
        solution = solveSudoku(base);
      }

      if (state.startTime) {
        startTime = state.startTime;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
      }

      statusText.textContent = "Resumed game";
      return true;
    } catch (e) {
      return false;
    }
  }

  /* PUZZLE INIT */

  function loadRandomPuzzle(diff) {
    const arr = PUZZLES[diff];
    const puzzle = arr[Math.floor(Math.random() * arr.length)];
    currentPuzzleStr = puzzle;

    const base = puzzleStringToBoard(puzzle);
    board = cloneBoard(base);
    given = new Array(81).fill(false);
    notes = Array.from({ length: 81 }, () => new Set());

    for (let i = 0; i < 81; i++) {
      if (base[i] !== 0) given[i] = true;
    }

    solution = solveSudoku(base);
    selectedIndex = null;
    notesMode = false;
    notesBtn.classList.remove("toggled");
    hidePopupPad();
    startTimer();
    statusText.textContent = "In progress";
    saveState();
    render();
  }

  /* LOGIC HELPERS */

  function findRuleConflicts() {
    const conflicts = new Set();

    // rows
    for (let r = 0; r < 9; r++) {
      const seen = {};
      for (let c = 0; c < 9; c++) {
        const idx = rcToIndex(r, c);
        const v = board[idx];
        if (!v) continue;
        if (seen[v] !== undefined) {
          conflicts.add(idx);
          conflicts.add(seen[v]);
        } else {
          seen[v] = idx;
        }
      }
    }

    // cols
    for (let c = 0; c < 9; c++) {
      const seen = {};
      for (let r = 0; r < 9; r++) {
        const idx = rcToIndex(r, c);
        const v = board[idx];
        if (!v) continue;
        if (seen[v] !== undefined) {
          conflicts.add(idx);
          conflicts.add(seen[v]);
        } else {
          seen[v] = idx;
        }
      }
    }

    // boxes
    for (let br = 0; br < 3; br++) {
      for (let bc = 0; bc < 3; bc++) {
        const seen = {};
        for (let r = 0; r < 3; r++) {
          for (let c = 0; c < 3; c++) {
            const idx = rcToIndex(br * 3 + r, bc * 3 + c);
            const v = board[idx];
            if (!v) continue;
            if (seen[v] !== undefined) {
              conflicts.add(idx);
              conflicts.add(seen[v]);
            } else {
              seen[v] = idx;
            }
          }
        }
      }
    }

    return conflicts;
  }

  function clearDigitFromPeers(index, digit) {
    const { row, col } = indexToRC(index);

    // row
    for (let c = 0; c < 9; c++) {
      const idx = rcToIndex(row, c);
      if (idx !== index) notes[idx].delete(digit);
    }
    // col
    for (let r = 0; r < 9; r++) {
      const idx = rcToIndex(r, col);
      if (idx !== index) notes[idx].delete(digit);
    }
    // box
    const boxRow = Math.floor(row / 3) * 3;
    const boxCol = Math.floor(col / 3) * 3;
    for (let r = 0; r < 3; r++) {
      for (let c = 0; c < 3; c++) {
        const idx = rcToIndex(boxRow + r, boxCol + c);
        if (idx !== index) notes[idx].delete(digit);
      }
    }
  }

function isSolvedCompletely() {
  // With strict "no mistakes" mode, solved means:
  // every cell matches the solution
  if (!solution) return false;
  for (let i = 0; i < 81; i++) {
    if (board[i] !== solution[i]) return false;
  }
  return true;
}


  /* POPUP PAD */

  function hidePopupPad() {
    popupPad.classList.add("hidden");
  }

  function showPopupPad(cellEl) {
    const gridRect = gridEl.getBoundingClientRect();
    const cellRect = cellEl.getBoundingClientRect();
    const x = cellRect.left + cellRect.width / 2 - gridRect.left;
    const y = cellRect.top + cellRect.height / 2 - gridRect.top;
    popupPad.style.left = x + "px";
    popupPad.style.top = y + "px";
    popupPad.classList.remove("hidden");
  }

  gridEl.addEventListener("click", (e) => {
    if (!popupPad.contains(e.target) && !e.target.classList.contains("cell")) {
      hidePopupPad();
    }
  });

  /* INPUT HANDLERS */

  function handleCellTap(index, cellEl) {
    selectedIndex = index;
    const editableBlank = !given[index] && board[index] === 0;
    render();
    if (editableBlank && !notesMode && cellEl) {
      showPopupPad(cellEl);
    } else {
      hidePopupPad();
    }
  }

 function handleNumberTap(num) {
  if (selectedIndex === null) return;
  if (given[selectedIndex]) return;

  const idx = selectedIndex;

  // NOTES MODE ‚Äì pencil marks only
  if (notesMode) {
    const set = notes[idx];
    if (set.has(num)) set.delete(num);
    else set.add(num);
    board[idx] = 0;
    statusText.textContent = "Notes updated";
    hidePopupPad();
    saveState();
    render();
    return;
  }

  // NORMAL MODE ‚Äì always place the number first
  board[idx] = num;

  // 1) Check row/column/box conflicts
  const conflicts = findRuleConflicts();

  // 2) Check against the true solution (strict "no mistakes" mode)
  if (solution && board[idx] !== solution[idx]) {
    conflicts.add(idx);
  }

  if (conflicts.size > 0) {
    // ‚ùå Wrong move: keep the number, show it in red
    statusText.textContent = "That number can't go there.";
    hidePopupPad();
    saveState();
    render(conflicts);   // cell stays filled but highlighted as error
    return;
  }

  // ‚úÖ Move is valid: clear notes in this cell and peers
  notes[idx].clear();
  clearDigitFromPeers(idx, num);

  if (isSolvedCompletely()) {
    statusText.textContent = "Completed üéâ";
    if (timerInterval) clearInterval(timerInterval);
  } else {
    statusText.textContent = "In progress";
  }

  hidePopupPad();
  saveState();
  render();
}

  function handleErase() {
    if (selectedIndex === null) return;
    if (given[selectedIndex]) return;
    board[selectedIndex] = 0;
    notes[selectedIndex].clear();
    statusText.textContent = "In progress";
    hidePopupPad();
    saveState();
    render();
  }

  function handleCheck() {
    const ruleConflicts = findRuleConflicts();
    const allConflicts = new Set(ruleConflicts);

    if (solution) {
      for (let i = 0; i < 81; i++) {
        if (board[i] !== 0 && board[i] !== solution[i]) {
          allConflicts.add(i);
        }
      }
    }

    if (allConflicts.size === 0) {
      statusText.textContent = "No conflicts so far ‚úÖ";
    } else {
      statusText.textContent = `${allConflicts.size} issue(s) found ‚ùó`;
    }
    render(allConflicts);
  }

  function handleHint() {
    if (selectedIndex === null || given[selectedIndex]) return;
    if (board[selectedIndex] !== 0) return;

    if (solution) {
      board[selectedIndex] = solution[selectedIndex];
      notes[selectedIndex].clear();
      clearDigitFromPeers(selectedIndex, board[selectedIndex]);
      statusText.textContent = "Hint applied üí°";
      if (isSolvedCompletely()) {
        statusText.textContent = "Completed üéâ";
        if (timerInterval) clearInterval(timerInterval);
      }
      saveState();
      render();
      return;
    }
  }

  function toggleNotesMode() {
    notesMode = !notesMode;
    notesBtn.classList.toggle("toggled", notesMode);
    hidePopupPad();
    render();
  }

  function clearNotes() {
    if (selectedIndex === null) return;
    notes[selectedIndex].clear();
    saveState();
    render();
  }

  /* RENDERING */

  function updatePadVisibility() {
    const counts = Array(10).fill(0);
    for (let i = 0; i < 81; i++) {
      const v = board[i];
      if (v) counts[v]++;
    }
    padButtons.forEach(btn => {
      const num = parseInt(btn.dataset.num, 10);
      if (!notesMode && counts[num] >= 9) {
        btn.classList.add("hidden-num");
      } else {
        btn.classList.remove("hidden-num");
      }
    });
  }

  function render(conflictsOverride) {
    gridEl.innerHTML = "";
    const conflicts = conflictsOverride || findRuleConflicts();
    const selectedVal = selectedIndex !== null ? board[selectedIndex] : null;

    for (let i = 0; i < 81; i++) {
      const cell = document.createElement("button");
      cell.className = "cell";
      const { row, col } = indexToRC(i);
      cell.dataset.row = row;
      cell.dataset.col = col;

      const inner = document.createElement("div");
      inner.className = "cell-inner";

      if (given[i]) {
        cell.classList.add("given");
      } else if (board[i] === 0 && notes[i].size === 0) {
        cell.classList.add("empty");
      }

      if (board[i] !== 0) {
        inner.textContent = board[i];
      } else if (notes[i].size > 0) {
        const small = document.createElement("div");
        small.style.fontSize = "11px";
        small.style.lineHeight = "1.1";
        small.style.opacity = "0.9";
        small.style.display = "grid";
        small.style.gridTemplateColumns = "repeat(3, 1fr)";
        small.style.width = "95%";
        small.style.height = "95%";
        for (let n = 1; n <= 9; n++) {
          const span = document.createElement("span");
          span.style.fontSize = "10px";
          span.style.opacity = notes[i].has(n) ? "1" : "0.18";
          span.textContent = notes[i].has(n) ? n : " ";
          small.appendChild(span);
        }
        inner.appendChild(small);
      } else {
        inner.textContent = "";
      }

      if (i === selectedIndex) {
        cell.classList.add("selected");
      } else if (selectedIndex !== null) {
        const { row: sr, col: sc } = indexToRC(selectedIndex);
        if (row === sr || col === sc ||
            (Math.floor(row / 3) === Math.floor(sr / 3) &&
             Math.floor(col / 3) === Math.floor(sc / 3))) {
          cell.classList.add("related");
        }
      }

      if (selectedVal && board[i] === selectedVal && i !== selectedIndex) {
        cell.classList.add("same-value");
      }

      if (conflicts.has(i)) {
        cell.classList.add("conflict");
      }

      cell.addEventListener("click", (evt) => handleCellTap(i, evt.currentTarget));
      cell.appendChild(inner);
      gridEl.appendChild(cell);
    }

    updatePadVisibility();
  }

  /* EVENTS */

  difficultyEl.addEventListener("change", () => {
    currentDifficulty = difficultyEl.value;
  });

  newGameBtn.addEventListener("click", () => {
    loadRandomPuzzle(currentDifficulty);
  });

  padButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const num = parseInt(btn.dataset.num, 10);
      handleNumberTap(num);
    });
  });

  popupPad.querySelectorAll(".popup-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const num = parseInt(btn.dataset.num, 10);
      handleNumberTap(num);
    });
  });

  eraseBtn.addEventListener("click", handleErase);
  notesBtn.addEventListener("click", toggleNotesMode);
  clearNotesBtn.addEventListener("click", clearNotes);
  checkBtn.addEventListener("click", handleCheck);
  hintBtn.addEventListener("click", handleHint);

  /* INIT */

  if (!loadState()) {
    loadRandomPuzzle(currentDifficulty);
  } else {
    render();
  }
</script>
</body>
</html>
